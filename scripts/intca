#!/bin/bash

set -e

sed -i "s/C = .*/C =/g" confs/ca.cnf
sed -i "s/ST = .*/ST =/g" confs/ca.cnf
sed -i "s/L = .*/L =/g" confs/ca.cnf
sed -i "s/O = .*/O =/g" confs/ca.cnf
sed -i "s/OU = .*/OU =/g" confs/ca.cnf
sed -i "s/CN = .*/CN =/g" confs/ca.cnf
sed -i "s/C =/C = $COUNTRY/g" confs/ca.cnf
sed -i "s/ST =/ST = $PROVINCE/g" confs/ca.cnf
sed -i "s/L =/L = $LOCALITY/g" confs/ca.cnf
sed -i "s/O =/O = $ORGANIZATION/g" confs/ca.cnf
sed -i "s/OU =/OU = $UNIT/g" confs/ca.cnf
sed -i "s/CN =/CN = $DOMAIN/g" confs/ca.cnf

#Generate the private key
openssl genrsa -out out/ca/keys/intca.key 4096
#Generate the CSR
openssl req -sha512 -new -subj "/C=$COUNTRY/ST=$PROVINCE/O=$ORGANIZATION/OU=$UNIT/L=$LOCALITY/CN=$DOMAIN" -key out/ca/keys/intca.key -out out/ca/csr/intca.csr
#Generate the intermediate certificate
openssl ca -batch -config confs/ca.cnf -days $DAYS -extensions v3_ca -subj "/C=$COUNTRY/ST=$PROVINCE/O=$ORGANIZATION/OU=$UNIT/L=$LOCALITY/CN=$DOMAIN" -notext -in out/ca/csr/intca.csr -out out/ca/certs/intca.crt
#Deletion of all *.pem generated by OpenSSL to keep only the .crt
rm -f cacerts/*.pem
